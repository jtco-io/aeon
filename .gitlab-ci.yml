variables:
  DOCKER_DRIVER: overlay2

stages:
#  - fasttest
  - build_test_deploy
#
#fasttest:
#  stage: fasttest
#  image: node:latest
#  # This folder is cached between builds
#  # http://docs.gitlab.com/ce/ci/yaml/README.html#cache
#  cache:
#    paths:
#    - node_modules/
#  script:
#   - yarn install
#   - yarn run lint
#   - yarn run flow check

build_test_deploy:
  stage: build_test_deploy
  image: docker:latest
  services:
    - docker:dind
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
    APK_CACHE_DIR: "$CI_PROJECT_DIR/cache-apk"
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/cache-pip"
  cache:
    paths:
    - $APK_CACHE_DIR
    - $PIP_CACHE_DIR
  before_script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
    - mkdir cache $APK_CACHE_DIR $PIP_CACHE_DIR
    - ln -s /var/cache/apk $APK_CACHE_DIR
    - ls $APK_CACHE_DIR
    - ls $PIP_CACHE_DIR
    - apk update
    - apk add py-pip yarn
    - pip install docker-compose
    - yarn run d:build
  script:
     - ls $APK_CACHE_DIR
     - ls $PIP_CACHE_DIR
     - yarn run d:test
#  after_script:
#    - docker push $IMAGE_NAME
